<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Dashboard Camping La Plage</title>
  <style>
    /* ===== Palette claire ===== */
    :root{
      --bg:#f8fafc; --bg-2:#ffffff; --panel:#ffffff; --muted:#f1f5f9; --line:#e5e7eb;
      --text:#0f172a; --text-dim:#64748b; --accent:#2563eb; --accent-2:#16a34a; --danger:#dc2626;
      --shadow:0 10px 30px rgba(0,0,0,.08); --radius:18px;
      --safe-top: env(safe-area-inset-top); --safe-bottom: env(safe-area-inset-bottom);
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,"Noto Sans";
      font-size:clamp(14px,2.6vw,16px);line-height:1.45;color:var(--text);background:var(--bg);
      padding-top:var(--safe-top);padding-bottom:var(--safe-bottom)}
/* Logo sur l'√©cran de connexion */
.login-logo{
  max-height: 60px;
  height: auto;
  width: auto;
  object-fit: contain;
}
@media (min-width: 520px){
  .login-logo{ max-height: 72px; }
}

    /* Auth guard */
    #app-view, .mobile-tabs{display:none}
    .is-auth #login-view{display:none}
    .is-auth #app-view{display:grid}
    .is-auth .mobile-tabs{display:flex}

    /* ===== D√©tail intervention + notes ===== */
    .detail-box{
      background:#f8fafc;border:1px solid var(--line);border-left:6px solid #93c5fd;
      border-radius:12px;padding:10px 12px;margin:8px 0;font-size:1rem
    }
    .detail-box.menage{ border-left-color:#86efac; }
    .detail-box .label{display:block;font-size:.78rem;color:var(--text-dim);margin-bottom:4px;letter-spacing:.2px}
    .notes{margin-top:8px;display:grid;gap:6px}
    .note{background:#fff;border:1px dashed #cbd5e1;border-radius:10px;padding:8px 10px}
    .note small{display:block;color:var(--text-dim)}
    .noteform{margin-top:8px;display:grid;gap:6px}
    .noteform textarea{min-height:70px}

    /* Components */
    .center{min-height:100dvh;display:grid;place-items:center;padding:20px}
    .card{width:min(100%,1000px);background:var(--panel);border:1px solid var(--line);border-radius:var(--radius);
      box-shadow:var(--shadow);padding:22px;position:relative;overflow:hidden}
    .card::after{content:"";position:absolute;inset:-2px;border-radius:calc(var(--radius) + 2px);padding:2px;
      background:linear-gradient(120deg,transparent, rgba(37,99,235,.25), transparent);
      -webkit-mask:linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);
      -webkit-mask-composite:xor;mask-composite:exclude;pointer-events:none}
    h1,h2,h3{margin:0 0 8px}
    h1{font-size:clamp(22px,5vw,32px)} h2{font-size:clamp(18px,4.2vw,24px)}
    .muted{color:var(--text-dim)}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}

    /* Inputs */
    label{font-size:.95rem;color:var(--text-dim)} .field{display:grid;gap:6px}
    input, select, textarea{width:100%;padding:12px 14px;border-radius:12px;border:1px solid var(--line);
      background:#fff;color:var(--text);font-size:16px;min-height:44px;outline:none;transition:border-color .2s, box-shadow .2s}
    textarea{min-height:90px;resize:vertical}
    input:focus, select:focus, textarea:focus{border-color:var(--accent);box-shadow:0 0 0 4px rgba(37,99,235,.15)}
    .btn{border:0;padding:12px 16px;border-radius:12px;cursor:pointer;font-weight:700;color:#fff;
      background:linear-gradient(180deg,var(--accent),#1d4ed8);box-shadow:0 8px 16px rgba(37,99,235,.20)}
    .btn.secondary{background:#fff;color:var(--text);border:1px solid var(--line)}
    .btn.danger{background:linear-gradient(180deg,var(--danger),#b91c1c)}
    .btn.small{padding:8px 10px;min-height:36px;font-size:.9rem}
    .chip{display:inline-flex;align-items:center;gap:6px;font-size:.75rem;color:#334155;background:var(--muted);
      border:1px solid #e2e8f0;border-radius:999px;padding:6px 10px}

    .content{padding:16px;padding-bottom:calc(100px + env(safe-area-inset-bottom))}

    .tiles{display:grid;grid-template-columns:repeat(1,minmax(0,1fr));gap:12px;margin-top:14px}
    .tile{position:relative;background:#fff;border:1px solid var(--line);border-radius:16px;padding:14px;
      box-shadow:0 8px 20px rgba(0,0,0,.05);cursor:pointer;transition:transform .08s ease, box-shadow .2s ease, border-color .2s}
    .tile:active{transform:translateY(1px)} .tile:hover{box-shadow:0 12px 24px rgba(0,0,0,.08);border-color:#cbd5e1}
    .tile h3{margin:0 0 6px;font-size:1rem} .tile .kpi-n{font-size:1.6rem;font-weight:800}

    /* ===== Header am√©lior√© ===== */
    .topbar{position:sticky;top:0;z-index:20;background:var(--bg-2);border-bottom:1px solid var(--line);
      box-shadow:0 2px 10px rgba(0,0,0,.04);display:grid;grid-template-columns:1fr auto;row-gap:8px;
      align-items:center;padding:12px 16px}
    #hello{font-weight:800;font-size:1.2rem;white-space:nowrap}
    #sessionUser{white-space:nowrap}
    .logout{background:#fff;color:var(--text-dim);border:1px solid var(--line);border-radius:12px;padding:10px 12px;cursor:pointer;min-height:44px}
    @media(min-width:700px){ .topbar{display:flex;justify-content:space-between} }

    .sidebar{display:none;background:var(--bg-2)}

    /* ===== Mobile bottom nav ===== */
    .mobile-tabs{
      position:fixed;left:0;right:0;bottom:0;z-index:30;background:rgba(255,255,255,.92);
      backdrop-filter:blur(10px);border-top:1px solid var(--line);
      padding:8px max(8px,env(safe-area-inset-right)) calc(8px + env(safe-area-inset-bottom)) max(8px,env(safe-area-inset-left));
      display:flex;gap:8px;overflow-x:auto;overscroll-behavior-x:contain;-webkit-overflow-scrolling:touch;scroll-snap-type:x mandatory
    }
    .mobile-tabs::-webkit-scrollbar{display:none}
    .mobile-tabs button{
      flex:0 0 auto; min-width:104px; scroll-snap-align:center;
      text-align:center;background:#fff;color:#000;border:1px solid var(--line);
      border-radius:12px;padding:10px 8px;min-height:44px;cursor:pointer;font-weight:600
    }
    .mobile-tabs button.active{border-color:#2563eb;box-shadow:0 0 0 3px rgba(37,99,235,.18) inset}

    /* Lists/cards */
    .list{display:grid;gap:10px;margin-top:10px}

    /* Chat */
    .chat-wrap{display:grid;grid-template-rows:1fr auto;min-height:320px;border:1px solid var(--line);border-radius:16px;overflow:hidden;background:#fff}
    .chat-list{padding:12px;display:flex;flex-direction:column;gap:10px;max-height:420px;overflow:auto;background:#fff}
    .msg{max-width:78%;padding:10px 12px;border-radius:14px;border:1px solid var(--line);background:#f8fafc}
    .msg.me{align-self:flex-end;background:#eef2ff;border-color:#dbeafe}

    @media (min-width:680px){.tiles{grid-template-columns:repeat(3,minmax(0,1fr))}}
    @media (min-width:900px){
      .app{grid-template-columns:260px 1fr}
      .sidebar{display:block;border-right:1px solid var(--line);padding:20px;position:sticky;top:0;height:100dvh}
      .content{padding:24px;padding-bottom:24px}
      .mobile-tabs{display:none}
    }

    /* ===== Statuts (3 couleurs) ===== */
    .status-pill{font-weight:700}
    .st-assign   { background:#fffbeb; color:#92400e; border:1px solid #f59e0b; }
    .st-progress { background:#eff6ff; color:#1e3a8a; border:1px solid #3b82f6; }
    .st-done     { background:#ecfdf5; color:#065f46; border:1px solid #16a34a; }

    /* ===== Cartes intervention ===== */
    .it{ position:relative; border:1px solid var(--line); border-radius:16px; background:#fff; padding:14px; box-shadow:0 6px 14px rgba(15,23,42,.04); }
    .it + .it{ margin-top:10px; }
    .it::before{ content:""; position:absolute; left:-1px; top:-1px; bottom:-1px; width:6px; border-radius:16px 0 0 16px; background:#cbd5e1;}
    .it.queue-tech::before{ background:#3b82f6; }
    .it.queue-men::before{  background:#16a34a; }
    .it .hdr{ display:flex; align-items:center; gap:10px; flex-wrap:wrap; margin-bottom:6px; }
    .it .id{ font-weight:800; letter-spacing:.2px; font-size:1.05rem; }
    .it .type{ font-weight:700; opacity:.85; }
    .badge{ display:inline-flex; align-items:center; gap:6px; border:1px solid var(--line); background:#f8fafc; color:#334155; border-radius:999px; padding:6px 10px; font-size:.8rem; font-weight:700; }
    .badge.status-pill.st-assign   { background:#fffbeb; color:#92400e; border-color:#f59e0b; }
    .badge.status-pill.st-progress { background:#eff6ff; color:#1e3a8a; border-color:#3b82f6; }
    .badge.status-pill.st-done     { background:#ecfdf5; color:#065f46; border-color:#16a34a; }
    .meta-grid{ display:grid; grid-template-columns:repeat(2,minmax(0,1fr)); gap:8px; margin:6px 0 8px 0; }
    @media (min-width:780px){ .meta-grid{ grid-template-columns:repeat(3,minmax(0,1fr)); } }
    .meta-pill{ background:#f1f5f9; border:1px solid #e2e8f0; padding:8px 10px; border-radius:12px; font-size:.9rem; }
    .meta-pill b{ font-weight:700; }
    .detail-box{ padding:12px 14px; }
    .detail-box .txt{ font-weight:700; line-height:1.45; }
    .notes{ display:grid; gap:8px; margin-top:6px; }
    .note{ background:#fff; border:1px dashed #cbd5e1; border-radius:12px; padding:10px 12px; }
    .note small{ display:block; color:#64748b; margin-top:4px; }
    .noteform{ margin-top:8px; display:grid; gap:8px; }
    .noteform textarea{ min-height:80px; }
    .noteform .actions{ display:flex; justify-content:flex-end; }
    .it .actions-row{ margin-top:8px; display:flex; flex-wrap:wrap; gap:8px; justify-content:flex-end; }

    /* Topbar ultra-responsive */
    .topbar { display: grid; grid-template-columns: 1fr auto; gap: 8px; align-items: center; }
    .topbar .row { min-width:0; flex-wrap:wrap; justify-content:flex-end; }
    .logout { white-space:nowrap; }
    @media (max-width:520px){
      .topbar{ grid-template-columns: 1fr; grid-auto-rows: auto; }
      #hello{ order:0; }
      .topbar .row{ order:1; justify-content:space-between; gap:6px; }
      .chip{ padding:4px 8px; font-size:.72rem; }
      .logout{ font-size:.9rem; padding:10px 12px; }
    }

    html, body { width:100%; overflow-x:hidden; }
    .hidden{ display:none !important; }
    .only-recadmin{ display:none; }
    .is-recadmin .only-recadmin{ display:block; }

    /* Pastilles Oui/Non */
    .meta-pill.yes{ background:#ecfdf5; border:1px solid #a7f3d0; color:#065f46; font-weight:700; }
    .meta-pill.no{  background:#fef2f2; border:1px solid #fecaca; color:#991b1b; font-weight:700; }
    .meta-pill.yes::before{ content:"‚úî "; font-weight:900; }
    .meta-pill.no::before{  content:"‚úñ "; font-weight:900; }

    .seg-field{ border:0; margin:0; padding:0 }
    .seg{ display:flex; gap:0; background:#f1f5f9; border:1px solid #e2e8f0; border-radius:999px; overflow:hidden; }
    .seg input[type=radio]{ position:absolute; opacity:0.0001; width:1px; height:1px; margin:-1px; padding:0; border:0; clip:rect(0 0 0 0); clip-path:inset(50%); overflow:hidden; }
    .seg label{ flex:1 1 50%; display:flex; align-items:center; justify-content:center; padding:12px 14px; cursor:pointer; user-select:none; text-align:center; color:#64748b; font-weight:700; -webkit-tap-highlight-color: transparent; }
    .seg label:first-of-type{ box-shadow:inset -1px 0 0 #e2e8f0; }
    .seg--yn input[value="oui"]:checked + label{ background:#16a34a; color:#fff }
    .seg--yn input[value="non"]:checked + label{ background:#dc2626; color:#fff }
    .seg input:focus + label{ box-shadow:0 0 0 3px rgba(37,99,235,.25) inset }
  </style>
</head>
<body>
  <noscript style="color:#111;background:#fde047;padding:8px;display:block;text-align:center">Activez JavaScript pour utiliser l'authentification.</noscript>

  <!-- ================= Connexion ================= -->
  <main id="login-view" class="center" aria-labelledby="title-login">
    <section class="card" role="dialog" aria-modal="true" aria-describedby="desc-login">
      <header class="row" style="gap:12px;margin-bottom:8px;align-items:center">
        <img class="login-logo" src="assets/logo-la-plage.png" alt="Camping La Plage ‚Äî Argel√®s-sur-Mer" decoding="async">
        <div>
          <h1 id="title-login">Connexion</h1>
          <p id="desc-login" class="muted">Entrez vos identifiants pour acc√©der au dashboard.</p>
        </div>
      </header>

      <form id="login-form" autocomplete="off">
        <div class="field"><label for="userId">Identifiant</label><input id="userId" name="userId" type="text" placeholder="ex: admin" required /></div>
        <div class="field"><label for="password">Mot de passe</label><input id="password" name="password" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required /></div>
        <div class="row" style="justify-content:space-between;align-items:center;margin-top:6px">
          <div class="muted" id="error"></div>
          <button class="btn" type="submit">Se connecter</button>
        </div>
        <p class="muted" style="margin-top:10px;font-size:13px">D√©mo initiale: <code>admin / admin</code> (Admin). Vous pourrez cr√©er d'autres comptes ensuite.</p>
      </form>

      <p class="muted" style="margin-top:8px">
        Pas encore de compte ? <a href="#" id="showSignUp">Cr√©er un compte</a>
      </p>

      <form id="signup-form" class="card" style="display:none; margin-top:10px">
        <h3>Cr√©er un compte</h3>
        <div class="row">
          <div class="field" style="flex:2 1 220px">
            <label>Email</label>
            <input name="email" type="email" placeholder="ex: rec01@demo.local" required>
          </div>
          <div class="field" style="flex:2 1 220px">
            <label>Mot de passe</label>
            <input name="password" type="password" minlength="6" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
          </div>
        </div>
        <div class="row" style="justify-content:flex-end">
          <button class="btn" type="submit">Cr√©er mon compte</button>
        </div>
        <div class="muted" id="signupError" style="margin-top:6px"></div>
      </form>
    </section>
  </main>

  <!-- ================= Application ================= -->
  <div id="app-view" class="app">
    <aside class="sidebar">
      <div class="row" style="gap:10px;font-weight:800;letter-spacing:.3px;margin-bottom:16px">
        <div aria-hidden="true" style="width:34px;height:34px;border-radius:12px;background:conic-gradient(from 210deg, var(--accent), var(--accent-2));filter:saturate(1.2);"></div>
        <div>Mon Dashboard</div>
      </div>
      <div class="nav" role="tablist" aria-label="Onglets du dashboard">
        <button role="tab" class="btn secondary" data-tab="accueil">üè† Accueil</button>
        <button role="tab" class="btn secondary" data-tab="interventions">üõ†Ô∏è Interventions</button>
        <button role="tab" class="btn secondary" data-tab="chat">üí¨ Chat</button>
        <button role="tab" class="btn secondary" data-tab="personnes">üë• Personnes</button>
        <button role="tab" class="btn secondary" data-tab="utilisateurs" id="tab-users-btn" style="display:none">üë§ Utilisateurs</button>
        <button role="tab" class="btn secondary" data-tab="rapports">üìä Rapports</button>
        <button role="tab" class="btn secondary" data-tab="parametres">‚öôÔ∏è Param√®tres</button>
      </div>
    </aside>

    <section style="display:flex;flex-direction:column;min-width:0;">
      <header class="topbar">
        <div id="hello"></div>
        <div class="row" style="gap:8px;flex-wrap:nowrap">
          <span class="chip">R√¥le: <strong id="roleBadge">‚Äî</strong></span>
          <span class="muted" id="sessionUser"></span>
          <button class="logout" id="logoutBtn">Se d√©connecter</button>
        </div>
      </header>

      <div class="content">
        <!-- Accueil -->
        <div class="tab" id="tab-accueil">
          <div class="row" style="justify-content:space-between;margin-bottom:8px">
            <h2 style="margin:0">Vue d'ensemble</h2>
            <span class="chip">üèïÔ∏è Camping La Plage ‚≠ê‚≠ê‚≠ê</span>
          </div>
          <p class="muted"></p>

          <div class="tiles" id="home-tiles">
            <button id="tile-tech" class="tile" data-goto="interventions">
              <h3>üõ†Ô∏è Interventions</h3>
              <div class="kpi-n" id="kpi-interv-tech">0</div>
              <div class="muted">Tech ‚Äî Ouvertes</div>
            </button>

            <button id="tile-men" class="tile" data-goto="interventions">
              <h3>üßπ Interventions</h3>
              <div class="kpi-n" id="kpi-interv-men">0</div>
              <div class="muted">M√©nage ‚Äî Ouvertes</div>
            </button>

            <button class="tile" data-goto="chat">
              <h3>üí¨ Chat</h3>
              <div class="kpi-n" id="kpi-chat">0</div>
              <div class="muted">Msgs non lus</div>
            </button>

            <button class="tile" data-goto="personnes">
              <h3>üë• Nombre de vacancier</h3>
              <div class="kpi-n" id="kpi-people">0</div>
              <div class="muted">Occupants</div>
            </button>
          </div>
        </div>

        <!-- Interventions -->
        <div class="tab" id="tab-interventions" hidden>
          <div class="row" style="justify-content:space-between">
            <h2>Interventions</h2>
            <div class="row"><button id="exportCsv" class="btn secondary">‚¨áÔ∏è Export CSV</button></div>
          </div>
          <p class="muted"></p>

          <!-- Form -->
          <form id="form-interv" class="card" style="display:none">
            <div class="row" style="justify-content:space-between;align-items:center">
              <h3 style="margin-bottom:6px">‚ûï Nouvelle intervention</h3>
              <span class="chip">Assignation auto selon type</span>
            </div>

            <div class="row" style="align-items:flex-start;gap:12px">
              <div class="field" style="flex:1 1 160px">
                <label>Type</label>
                <select name="type" required>
                  <option value="Technique">Technique</option>
                  <option value="M√©nage">M√©nage</option>
                </select>
              </div>

              <div class="field" style="flex:1 1 160px">
                <label>Priorit√©</label>
                <select name="prio" required>
                  <option>Normale</option>
                  <option>Haute</option>
                  <option>Urgente</option>
                </select>
              </div>

              <div class="field" style="flex:2 1 240px">
                <label>Mobil Home</label>
                <input name="lieu" placeholder="Ecrire..." required>
              </div>
            </div>

            <div class="field">
              <label>D√©tail</label>
              <textarea name="detail" placeholder="D√©crivez le probl√®me..." required></textarea>
            </div>

            <!-- Champs visibles seulement Admin/R√©ception -->
            <div class="field">
              <label>Clients pr√©sents ?</label>
              <fieldset class="seg-field">
                <div class="seg seg--yn" role="radiogroup" aria-label="Clients pr√©sents">
                  <input type="radio" id="clients-oui" name="clients" value="oui">
                  <label for="clients-oui">Oui</label>
                  <input type="radio" id="clients-non" name="clients" value="non" checked>
                  <label for="clients-non">Non</label>
                </div>
              </fieldset>
            </div>

            <div class="field">
              <label>Autorisation d'entr√©e ?</label>
              <fieldset class="seg-field">
                <div class="seg seg--yn" role="radiogroup" aria-label="Autorisation d'entr√©e">
                  <input type="radio" id="entry-oui" name="entry" value="oui">
                  <label for="entry-oui">Oui</label>
                  <input type="radio" id="entry-non" name="entry" value="non" checked>
                  <label for="entry-non">Non</label>
                </div>
              </fieldset>
            </div>

            <div class="row" style="justify-content:flex-end">
              <button class="btn" type="submit">Cr√©er</button>
            </div>
          </form>

          <!-- Filtres -->
          <div class="row" style="margin-top:10px">
            <input id="searchInterv" placeholder="Recherche (MH, d√©tail, id)" style="flex:2 1 220px">
            <select id="filterStatus" style="flex:1 1 160px">
              <option value="all">Tous statuts</option>
              <option>Ouverte</option>
              <option>Assign√©e</option>
              <option>En cours</option>
              <option>Termin√©e</option>
            </select>
          </div>

          <!-- Files -->
          <div class="row" style="margin-top:12px;align-items:flex-start">
            <div class="card" style="flex:1 1 320px">
              <h3>üîß File Techniciens</h3>
              <div class="list" id="list-tech"></div>
            </div>
            <div class="card" style="flex:1 1 320px">
              <h3>üßπ File M√©nage</h3>
              <div class="list" id="list-men"></div>
            </div>
          </div>
        </div>

        <!-- Chat -->
        <div class="tab" id="tab-chat" hidden>
          <h2>Chat interne</h2>
          <div class="row" style="gap:10px;margin:6px 0">
            <select id="chatChannel">
              <option value="general">#g√©n√©ral</option>
              <option value="reception">#r√©ception</option>
              <option value="techniciens">#techniciens</option>
              <option value="menage">#m√©nage</option>
              <option value="interventions">#interventions</option>
            </select>
            <span class="chip">R√¥le courant: <strong id="roleBadge2">‚Äî</strong></span>
          </div>
          <div class="chat-wrap">
            <div id="chatList" class="chat-list" aria-live="polite"></div>
            <form id="chatForm" class="row" style="padding:10px;background:#fff;border-top:1px solid #e5e7eb">
              <input id="chatMsg" placeholder="√âcrire un message..." />
              <button class="btn" type="submit">Envoyer</button>
            </form>
          </div>
        </div>

        <!-- Personnes -->
        <div class="tab" id="tab-personnes" hidden>
          <h2>Personnes</h2>
          <div class="row">
            <div class="card" style="flex:1 1 280px">
              <h3>üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Clients pr√©sents</h3>
              <div class="row" style="align-items:center;gap:10px;margin-top:6px">
                <button class="btn secondary" data-people="clients:-5">-5</button>
                <button class="btn secondary" data-people="clients:-1">-1</button>
                <div class="kpi-n" id="count-clients">0</div>
                <button class="btn secondary" data-people="clients:+1">+1</button>
                <button class="btn secondary" data-people="clients:+5">+5</button>
              </div>
            </div>
            <div class="card" style="flex:1 1 280px">
              <h3>üßë‚Äçüîß √âquipe</h3>
              <div class="row" style="align-items:center;gap:10px;margin-top:6px">
                <button class="btn secondary" data-people="staff:-1">-1</button>
                <div class="kpi-n" id="count-staff">0</div>
                <button class="btn secondary" data-people="staff:+1">+1</button>
              </div>
            </div>
            <div class="card" style="flex:1 1 280px">
              <h3>üìä R√©sum√©</h3>
              <p>Total sur site: <strong id="count-total">0</strong></p>
            </div>
          </div>
        </div>

        <!-- Utilisateurs (Admin) -->
        <div class="tab" id="tab-utilisateurs" hidden>
          <h2>Gestion des utilisateurs</h2>
          <p class="muted">Cr√©ation de comptes R√©ception / Technicien / M√©nage. (Stockage d√©mo localStorage)</p>
          <form id="userForm" class="card" style="margin-top:8px">
            <div class="row">
              <div class="field" style="flex:2 1 200px"><label>Identifiant</label><input name="u" placeholder="ex: rec01" required></div>
              <div class="field" style="flex:2 1 200px"><label>Mot de passe</label><input name="p" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required></div>
              <div class="field" style="flex:1 1 160px"><label>R√¥le</label>
                <select name="r"><option>R√©ception</option><option>Technicien</option><option>M√©nage</option></select>
              </div>
              <div class="field" style="align-self:flex-end"><button class="btn" type="submit">Cr√©er</button></div>
            </div>
          </form>
          <div class="card" style="margin-top:12px">
            <h3>Liste des comptes</h3>
            <div id="userList" class="list"></div>
          </div>
          <div class="card only-recadmin" style="margin-top:12px">
  <h3 style="margin-bottom:10px">Invitations (Supabase)</h3>
        </div>
<!-- ===== Invitations (Admin/R√©ception) ===== -->


  <!-- Cr√©ation d‚Äôune invitation -->
  <form id="inviteForm" class="row" style="align-items:flex-end">
    <div class="field" style="flex:2 1 260px">
      <label>Email √† inviter</label>
      <input name="email" type="email" placeholder="ex: rec01@demo.local" required />
    </div>
    <div class="field" style="flex:1 1 200px">
      <label>R√¥le attribu√©</label>
      <select name="role">
        <option>R√©ception</option>
        <option>Technicien</option>
        <option>M√©nage</option>
        <option>Admin</option>
      </select>
    </div>
    <div class="field">
      <button class="btn" type="submit">Cr√©er l‚Äôinvitation</button>
    </div>
  </form>

  <!-- Liste des invitations -->
  <div id="invitesList" class="list" style="margin-top:10px"></div>
  <div id="invitesMsg" class="muted" style="margin-top:6px"></div>
</div>

        <!-- Rapports / Param√®tres -->
        <div class="tab" id="tab-rapports" hidden><h2>Rapports</h2><p class="muted">√Ä venir.</p></div>
        <div class="tab" id="tab-parametres" hidden><h2>Param√®tres</h2><p class="muted">Pr√©f√©rences.</p></div>
      </div>
    </section>
  </div>

  <!-- Mobile Tabs -->
  <nav class="mobile-tabs" aria-label="Navigation principale">
    <button class="active" data-tab="accueil">üè†<br><span style="font-size:12px">Accueil</span></button>
    <button data-tab="interventions">üõ†Ô∏è<br><span style="font-size:12px">Interventions</span></button>
    <button data-tab="chat">üí¨<br><span style="font-size:12px">Chat</span></button>
    <button data-tab="personnes">üë•<br><span style="font-size:12px">Personnes</span></button>
    <button id="tab-users-btn-m" style="display:none" data-tab="utilisateurs">üë§<br><span style="font-size:12px">Utilisateurs</span></button>
    <button data-tab="rapports">üìä<br><span style="font-size:12px">Rapports</span></button>
    <button data-tab="parametres">‚öôÔ∏è<br><span style="font-size:12px">Param√®tres</span></button>
  </nav>

  <!-- === Supabase SDK (remplace Firebase) === -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // === 0) Config Supabase ===
    const SUPABASE_URL = "https://upszoarzjcmiowzqfnff.supabase.co"; // <- tes valeurs
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVwc3pvYXJ6amNtaW93enFmbmZmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg0NDYwNjcsImV4cCI6MjA3NDAyMjA2N30.3Knmz9xQpA-wPfiVZnnoXlXBwqPpedIq42nAZxCmITU";
    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // === 1) Fonctions "compat" attendues par le code existant ===
    // -> Login avec email/mot de passe
    window.firebaseLogin = async function(email, password){
      const { data, error } = await sb.auth.signInWithPassword({ email, password });
      if (error) throw error;
      const uid = data.user.id;

      // R√©cup√©rer le r√¥le depuis la table profiles (id = auth.users.id)
      let role = "Technicien";
      const { data: prof, error: perr } = await sb
        .from("profiles")
        .select("role")
        .eq("id", uid)
        .single();

      if (!perr && prof?.role) role = prof.role;

      localStorage.setItem("demo-dashboard-session", JSON.stringify({
        userId: email.split("@")[0], role, when: Date.now()
      }));
      return true;
    };

    // -> Signup avec "invitation" (table invites)
    async function signupWithInvite(email, password){
      // 1/ V√©rifier une invite active
      const { data: invites, error: invErr } = await sb
        .from("invites")
        .select("id, role, used")
        .eq("email", email.toLowerCase())
        .eq("used", false)
        .limit(1);

      if (invErr) throw invErr;
      if (!invites || invites.length === 0) throw new Error("Aucune invitation active pour cet email.");

      const invite = invites[0];

      // 2/ Cr√©er le compte
      const { data: sign, error: sErr } = await sb.auth.signUp({
        email,
        password
      });
      if (sErr) throw sErr;
      const uid = sign.user.id;

      // 3/ Cr√©er/mettre √† jour le profil (role)
      const { error: pErr } = await sb
        .from("profiles")
        .upsert({ id: uid, role: invite.role }, { onConflict: "id" });
      if (pErr) throw pErr;

      // 4/ Marquer l'invite "used"
      const { error: uErr } = await sb
        .from("invites")
        .update({ used: true })
        .eq("id", invite.id);
      if (uErr) throw uErr;

      // 5/ Poser la session locale (comme avant)
      localStorage.setItem("demo-dashboard-session", JSON.stringify({
        userId: email.split("@")[0], role: invite.role, when: Date.now()
      }));
    }
    window._signupWithInvite = signupWithInvite;

    // 2) Hooks UI de signup
    document.getElementById("showSignUp")?.addEventListener("click",(e)=>{
      e.preventDefault();
      document.getElementById("signup-form").style.display="block";
    });
    document.getElementById("signup-form")?.addEventListener("submit", async (e)=>{
      e.preventDefault();
      const f = new FormData(e.target);
      const email = String(f.get("email")||"").trim().toLowerCase();
      const pass  = String(f.get("password")||"").trim();
      const out = document.getElementById("signupError");
      out.textContent = "";
      try{
        await window._signupWithInvite(email, pass);
        window.enforceAuthUI?.();
      }catch(err){
        out.textContent = err?.message || "Cr√©ation impossible. V√©rifiez l‚Äôinvitation.";
      }
    });

/* ====================== INVITATIONS (Supabase) ====================== */
// Helpers
function uiMsg(el, txt, ok=true){
  el.textContent = txt || "";
  el.style.color = ok ? "#065f46" : "#991b1b";
}

// Rendu d‚Äôune ligne d‚Äôinvite
function renderInviteRow(inv){
  const used = inv.used ? "yes" : "no";
  const chipUsed = `<span class="chip" style="background:${inv.used ? '#ecfdf5' : '#fffbeb'};border-color:${inv.used ? '#a7f3d0' : '#f59e0b'};color:${inv.used ? '#065f46' : '#92400e'}">${inv.used ? 'UTILIS√âE' : 'ACTIVE'}</span>`;
  const when = inv.created_at ? new Date(inv.created_at).toLocaleString() : "‚Äî";

  const d = document.createElement("div");
  d.className = "it";
  d.innerHTML = `
    <div class="hdr" style="justify-content:space-between">
      <div class="row" style="gap:8px">
        <div class="id">${inv.email}</div>
        <span class="badge">R√¥le: <b>${inv.role || '‚Äî'}</b></span>
        ${chipUsed}
      </div>
      <div class="row">
        ${!inv.used ? `<button class="btn danger small" data-inv-del="${inv.id}">Supprimer</button>` : ""}
      </div>
    </div>
    <div class="muted" style="font-size:.9rem">Cr√©√©e le ${when}${inv.used_at ? ` ‚Ä¢ utilis√©e le ${new Date(inv.used_at).toLocaleString()}` : ""}</div>
  `;
  return d;
}

// Charge la liste
async function loadInvites(){
  const list = document.getElementById("invitesList");
  const msg  = document.getElementById("invitesMsg");
  if(!list) return;

  list.innerHTML = "";
  uiMsg(msg, "Chargement‚Ä¶", true);

  const { data, error } = await sb
    .from("invites")
    .select("*")
    .order("created_at", { ascending:false });

  if(error){
    uiMsg(msg, "Erreur de lecture des invitations : " + (error.message || error), false);
    return;
  }
  uiMsg(msg, data.length ? "" : "Aucune invitation pour le moment.");
  data.forEach(inv => list.appendChild(renderInviteRow(inv)));
}

// Cr√©e une invitation
async function createInvite(email, role){
  const { data, error } = await sb
    .from("invites")
    .insert({ email: String(email).toLowerCase().trim(), role })
    .select()
    .single();
  if(error) throw error;
  return data;
}

// Supprime une invitation (si non utilis√©e)
async function deleteInvite(id){
  const { error } = await sb.from("invites").delete().eq("id", id);
  if(error) throw error;
}

// Hook formulaire
document.getElementById("inviteForm")?.addEventListener("submit", async (e)=>{
  e.preventDefault();
  const f   = new FormData(e.target);
  const msg = document.getElementById("invitesMsg");
  uiMsg(msg, "");

  try{
    await createInvite(f.get("email"), f.get("role"));
    e.target.reset();
    await loadInvites();
    uiMsg(msg, "Invitation cr√©√©e ‚úÖ", true);
  }catch(err){
    uiMsg(msg, "Cr√©ation impossible : " + (err?.message || err), false);
  }
});

// Hook suppression (d√©l√©gation)
document.getElementById("invitesList")?.addEventListener("click", async (e)=>{
  const btn = e.target.closest("[data-inv-del]");
  if(!btn) return;
  if(!confirm("Supprimer cette invitation ?")) return;

  const id  = btn.getAttribute("data-inv-del");
  const msg = document.getElementById("invitesMsg");
  uiMsg(msg, "");

  try{
    await deleteInvite(id);
    await loadInvites();
    uiMsg(msg, "Invitation supprim√©e ‚úÖ", true);
  }catch(err){
    uiMsg(msg, "Suppression impossible : " + (err?.message || err), false);
  }
});

// Charger la liste quand l‚Äôutilisateur est authentifi√© dans l‚Äôapp
// (ton enforceAuthUI() est d√©j√† appel√© au chargement)
const _oldEnforce = enforceAuthUI;
enforceAuthUI = function(){
  _oldEnforce?.();
  // Montrer/M√†J la liste seulement si connect√© et r√¥le Admin/R√©ception
  if(isLogged()){
    const c = current();
    if(c && (c.role === "Admin" || c.role === "R√©ception")){
      loadInvites();
    }
  }
  if (canManage && typeof loadInvites === "function") {
  loadInvites();
}

}
</script>

<script>
/* ====== Cl√©s session locales minimalistes (r√¥le, userId) ====== */
const KEY="demo-dashboard-session", UKEY="camping-users"; // UKEY reste pour la page "Utilisateurs" d√©mo locale
const defaultUsers=[{u:"admin",p:"admin",r:"Admin"}];
function getUsers(){ try{const u=JSON.parse(localStorage.getItem(UKEY)); return Array.isArray(u)&&u.length?u:defaultUsers;}catch{return defaultUsers;} }
function saveUsers(l){ localStorage.setItem(UKEY, JSON.stringify(l)); }
function addUser(u,p,r){ const l=getUsers(); if(l.some(x=>x.u===u)) return false; l.push({u,p,r}); saveUsers(l); return true; }
function delUser(u){ saveUsers(getUsers().filter(x=>x.u!==u || x.r==="Admin")); }

function login(u,p){ const user=getUsers().find(x=>x.u===u && x.p===p); if(user){ localStorage.setItem(KEY, JSON.stringify({userId:u, role:user.r, when:Date.now()})); return true;} return false; }
function current(){ try{return JSON.parse(localStorage.getItem(KEY))}catch{return null} }
function isLogged(){ return !!current(); }

/* ====== UI de base ====== */
function setGreeting(){ const h=new Date().getHours(); document.getElementById("hello").textContent=h<12?"Bonjour !":(h<18?"Bon apr√®s-midi !":"Bonsoir !"); }
function enforceAuthUI(){
  if(isLogged()){
    const c=current(); document.body.classList.add("is-auth");
    const canManage = (c.role==="Admin" || c.role==="R√©ception");
    document.body.classList.toggle("is-recadmin", canManage);
    document.getElementById("sessionUser").textContent="Connect√© : "+c.userId;
    document.getElementById("roleBadge").textContent=c.role; document.getElementById("roleBadge2").textContent=c.role;
    const isAdmin=c.role==="Admin";
    document.getElementById("form-interv").style.display=(isAdmin||c.role==="R√©ception")?"block":"none";
    document.getElementById("tab-users-btn").style.display=isAdmin?"block":"none";
    document.getElementById("tab-users-btn-m").style.display=isAdmin?"block":"none";

    // Accueil : tuile selon r√¥le
    if(isAdmin || c.role==="R√©ception"){
      homeTileTech?.classList.remove("hidden"); homeTileMen?.classList.remove("hidden");
    } else if(c.role==="Technicien"){
      homeTileTech?.classList.remove("hidden"); homeTileMen?.classList.add("hidden");
    } else if(c.role==="M√©nage"){
      homeTileTech?.classList.add("hidden");    homeTileMen?.classList.remove("hidden");
    }

    history.replaceState({app:true}, "", "#app");
    bootstrapData(); // charge depuis Supabase
  }else{
    document.body.classList.remove("is-auth"); history.replaceState({app:false}, "", "#login");
  }
}

/* ====== Login events ====== */
document.getElementById("login-form").addEventListener("submit", async (e)=>{
  e.preventDefault();
  const id = e.target.userId.value.trim();
  const pw = e.target.password.value.trim();
  const out = document.getElementById("error");
  out.textContent = "";

  try {
    if (id.includes("@")) {
      await window.firebaseLogin(id, pw); // => pose KEY avec role/userId
    } else {
      if (!login(id, pw)) throw new Error("Identifiants invalides.");
    }
    enforceAuthUI();
  } catch (err) {
    out.textContent = err?.message || "Connexion impossible.";
  }
});

document.getElementById("logoutBtn").addEventListener("click", async ()=>{
  try{ await sb.auth.signOut(); }catch{}
  localStorage.removeItem(KEY);
  enforceAuthUI();
});

/* ===== Tabs ===== */
function selectTab(name){
  if(!isLogged()) return;
  document.querySelectorAll(".nav button, .mobile-tabs button").forEach(b=>{
    const a=b.dataset.tab===name; b.classList.toggle("active",a); b.setAttribute("aria-selected",a?"true":"false");
  });
  document.querySelectorAll(".tab").forEach(t=>t.hidden=(t.id!=="tab-"+name));
  document.querySelector(`.mobile-tabs button[data-tab="${name}"]`)?.scrollIntoView({behavior:"smooth", inline:"center", block:"nearest"});
}
document.body.addEventListener("click",e=>{ const btn=e.target.closest("button[data-tab]"); if(btn) selectTab(btn.dataset.tab); });
document.getElementById("home-tiles").addEventListener("click",e=>{ const b=e.target.closest("[data-goto]"); if(b) selectTab(b.dataset.goto); });

/* ===== Swipe ===== */
let startX=0; document.addEventListener("touchstart",e=>{startX=e.touches[0].clientX;});
document.addEventListener("touchend",e=>{let endX=e.changedTouches[0].clientX, d=endX-startX;
  if(Math.abs(d)>80){ const tabs=[...document.querySelectorAll(".mobile-tabs button")].map(b=>b.dataset.tab);
    const i=tabs.findIndex(t=>document.querySelector(`.mobile-tabs button[data-tab="${t}"]`).classList.contains("active"));
    const n=d<0?(i+1)%tabs.length:(i-1+tabs.length)%tabs.length; selectTab(tabs[n]); }});

/* ====== Data layer Supabase ====== */
const listTech=document.getElementById("list-tech"), listMen=document.getElementById("list-men");
const searchInterv=document.getElementById("searchInterv"), filterStatus=document.getElementById("filterStatus");
const homeTileTech = document.getElementById("tile-tech");
const homeTileMen  = document.getElementById("tile-men");
const chatList = document.getElementById("chatList");
const chatForm = document.getElementById("chatForm");
const chatMsg  = document.getElementById("chatMsg");
const chatChannel = document.getElementById("chatChannel");

let Intervs = [];  // m√©moire locale (miroir de la DB)
let Notes   = {};  // {intervention_id:[...]}
let History = {};
let People  = { clients:0, staff:0 };
let Chat    = [];

/* ------ Chargement initial ------ */
async function bootstrapData(){
  if(!isLogged()) return;
  await Promise.all([
    loadInterventions(),
    loadNotesAndHistory(),
    loadStats(),
    loadChatByChannel(chatChannel.value)
  ]);
  bindRealtime();
  renderAll();
}

/* ------ Interventions ------ */
async function loadInterventions(){
  const { data, error } = await sb
    .from('interventions')
    .select('*')
    .order('created_at', { ascending:false });
  if(!error && data){ Intervs = data; }
}

async function loadNotesAndHistory(){
  const [n,h] = await Promise.all([
    sb.from('interv_notes').select('*').order('created_at', { ascending:true }),
    sb.from('interv_history').select('*').order('at', { ascending:true })
  ]);
  Notes = {}; (n.data||[]).forEach(x=>{ (Notes[x.intervention_id] ||= []).push(x); });
  History = {}; (h.data||[]).forEach(x=>{ (History[x.intervention_id] ||= []).push(x); });
}

/* Cr√©ation via formulaire */
document.getElementById("form-interv").addEventListener("submit", async (e)=>{
  e.preventDefault();
  const d=new FormData(e.target), c=current(), type=d.get("type");
  const now=new Date().toISOString();
  const clientsPresent = d.get("clients")==="oui";
  const entryAllowed   = d.get("entry")==="oui";
  const assigne = type==="M√©nage" ? "M√©nage" : "Techniciens";

  const insert = {
    type, prio: d.get("prio"), lieu: d.get("lieu"), detail: d.get("detail"),
    assigne, status:"Assign√©e",
    created_by: (sb.auth.getUser && (await sb.auth.getUser())?.data?.user?.id) || null,
    handled_by: null,
    clients_present: clientsPresent,
    entry_allowed: entryAllowed
  };

  const { data, error } = await sb.from('interventions').insert(insert).select().single();
  if(error){ alert("Cr√©ation impossible : "+error.message); return; }

  await sb.from('interv_history').insert([
    { intervention_id: data.id, action: "Cr√©√©e", by_user: `${c.userId} (${c.role})` },
    { intervention_id: data.id, action: `Assign√©e √† ${assigne}`, by_user: `${c.userId} (${c.role})` }
  ]);

  (e.target).reset();
});

/* Actions sur carte */
function actionInterv(act, it){
  const c=current();
  const now = new Date().toISOString();
  if(act==="assign"){
    const next = it.assigne==="Techniciens" ? "M√©nage" : "Techniciens";
    return sb.from('interventions').update({ assigne: next, status:"Assign√©e", handled_by: null }).eq('id', it.id)
      .then(()=> sb.from('interv_history').insert({ intervention_id: it.id, action:`Re-assign√©e √† ${next}`, by_user:`${c.userId} (${c.role})` }));
  }
  if(act==="start"){
    return sb.from('interventions').update({ status:"En cours", handled_by:`${c.userId} (${c.role})` }).eq('id', it.id)
      .then(()=> sb.from('interv_history').insert({ intervention_id: it.id, action:`En cours`, by_user:`${c.userId} (${c.role})` }));
  }
  if(act==="done"){
    return sb.from('interventions').update({ status:"Termin√©e", handled_by:`${c.userId} (${c.role})` }).eq('id', it.id)
      .then(()=> sb.from('interv_history').insert({ intervention_id: it.id, action:`Termin√©e`, by_user:`${c.userId} (${c.role})` }));
  }
  if(act==="del"){
    return sb.from('interv_history').insert({ intervention_id: it.id, action:`Supprim√©e`, by_user:`${c.userId} (${c.role})` })
      .then(()=> sb.from('interventions').delete().eq('id', it.id));
  }
}

/* Sauvegarde note */
async function saveNote(intervId, text){
  const c=current();
  await sb.from('interv_notes').insert({
    intervention_id: intervId,
    by_user: `${c.userId} (${c.role})`,
    body: text
  });
  await sb.from('interv_history').insert({
    intervention_id: intervId,
    action:"Note ajout√©e",
    by_user: `${c.userId} (${c.role})`
  });
}

/* ------ Chat ------ */
chatChannel.addEventListener("change", async () => {
  await loadChatByChannel(chatChannel.value);
  renderChat();
});

async function loadChatByChannel(ch){
  const { data, error } = await sb
    .from('chat_messages')
    .select('*')
    .eq('channel', ch)
    .order('created_at', { ascending:true })
    .limit(300);
  if(!error){ Chat = data || []; }
}

chatForm.addEventListener("submit", async (e)=>{
  e.preventDefault();
  if(!isLogged()) return;
  const text = (chatMsg.value||"").trim();
  if(!text) return;
  const c = current();
  const { error } = await sb.from('chat_messages').insert({
    channel: chatChannel.value,
    user_name: c.userId,
    role: c.role,
    text
  });
  if(error){ alert(error.message); return; }
  chatMsg.value = "";
});

/* ------ Personnes (site_stats) ------ */
document.getElementById("tab-personnes").addEventListener("click", async e=>{
  const b=e.target.closest("[data-people]"); if(!b) return;
  const [k,d]=b.dataset.people.split(":"); const delta = Number(d);
  const next = { ...People, [k]: Math.max(0,(People[k]||0)+delta) };
  const { error } = await sb.from('site_stats').update({ clients: next.clients, staff: next.staff, updated_at: new Date().toISOString() }).eq('id',1);
  if(error) alert(error.message);
});

async function loadStats(){
  const { data, error } = await sb.from('site_stats').select('*').eq('id',1).single();
  if(!error && data){ People = { clients: data.clients||0, staff: data.staff||0 }; }
}

/* ------ Realtime ------ */
let RT = null;
function bindRealtime(){
  if(RT){ sb.removeChannel(RT); }
  RT = sb.channel('dashboard-stream')
    .on('postgres_changes', { event:'*', schema:'public', table:'interventions' }, async payload=>{
      // reload only this table row(s)
      await loadInterventions(); renderInterventions(); refreshKPIs();
    })
    .on('postgres_changes', { event:'*', schema:'public', table:'interv_notes' }, async payload=>{
      await loadNotesAndHistory(); renderInterventions();
    })
    .on('postgres_changes', { event:'*', schema:'public', table:'interv_history' }, async payload=>{
      await loadNotesAndHistory(); renderInterventions();
    })
    .on('postgres_changes', { event:'insert', schema:'public', table:'chat_messages' }, payload=>{
      const ch = chatChannel.value;
      if(payload.new.channel===ch){ Chat.push(payload.new); renderChat(); }
      refreshKPIs();
    })
    .on('postgres_changes', { event:'update', schema:'public', table:'site_stats' }, payload=>{
      People = { clients: payload.new.clients||0, staff: payload.new.staff||0 };
      renderPeople(); refreshKPIs();
    })
    .subscribe();
}

/* ======= RENDERING ======= */
[searchInterv, filterStatus].forEach(el=>el.addEventListener("input", renderInterventions));

const STATUS3 = {
  assign:   { pill:"st-assign",   card:"card-assign" },
  progress: { pill:"st-progress", card:"card-progress" },
  done:     { pill:"st-done",     card:"card-done" }
};
function statusKey(s){ if(s==="Termin√©e") return "done"; if(s==="En cours") return "progress"; return "assign"; }
function escapeHtml(s){ return (s||"").replace(/[&<>"]/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;"}[c])); }

function renderAll(){
  renderInterventions();
  renderPeople();
  renderChat();
  refreshKPIs();
}

function renderInterventions(){
  if(!isLogged()) return;
  const c=current(),
        q=(searchInterv.value||"").toLowerCase(),
        s=filterStatus.value;

  const techCard = listTech.parentElement;
  const menCard  = listMen.parentElement;

  const filtered = Intervs.filter(i =>
    (s==="all" || (s==="Assign√©e" ? i.status.startsWith("Assign√©e") : i.status===s)) &&
    ((i.lieu||"").toLowerCase().includes(q) || (i.detail||"").toLowerCase().includes(q) || (i.short_id||"").includes(q))
  );

  if(c.role==="R√©ception" || c.role==="Admin"){
    techCard.hidden = false; menCard.hidden  = false;
    renderList(listTech, filtered.filter(i=>i.assigne==="Techniciens"), c);
    renderList(listMen,  filtered.filter(i=>i.assigne==="M√©nage"),      c);
    return;
  }

  const isTech = c.role==="Technicien";
  const myQueue = isTech ? "Techniciens" : "M√©nage";
  if(isTech){ techCard.hidden=false; menCard.hidden=true; } else { techCard.hidden=true; menCard.hidden=false; }
  renderList(isTech ? listTech : listMen, filtered.filter(i=>i.assigne===myQueue), c);
  renderList(isTech ? listMen  : listTech, [], c);
}

function renderList(container, items, ctx){ container.innerHTML=""; items.forEach(i=>container.appendChild(itemCard(i,ctx))); }
function itemCard(i, ctx){
  const isReception = ctx.role==="R√©ception"||ctx.role==="Admin";
  const canWork = (ctx.role==="Technicien"&&i.assigne==="Techniciens")||(ctx.role==="M√©nage"&&i.assigne==="M√©nage");
  const canAddNote = canWork && i.status==="Termin√©e" && i.handled_by && i.handled_by.startsWith(ctx.userId);

  const st = STATUS3[statusKey(i.status)];
  const queueClass = i.assigne==="M√©nage" ? "queue-men" : "queue-tech";

  const wrap = document.createElement("div");
  wrap.className = `it ${queueClass} ${st.card}`;

  const hdr = `
    <div class="hdr">
      <div class="id">#${i.short_id || (i.id+"").slice(-6)}</div>
      <div class="type">‚Ä¢ ${i.type}</div>
      ${isReception ? `<span class="badge">Priorit√©: ${i.prio}</span>` : ""}
      <span class="badge status-pill ${st.pill}">Statut: ${i.status}</span>
    </div>`;

  const meta = `
  <div class="meta-grid">
    <div class="meta-pill"><b>Lieu</b> : ${escapeHtml(i.lieu)}</div>
    <div class="meta-pill"><b>Cr√©√©e par</b> : ${i.created_by ? "profil li√©" : "‚Äî"}</div>
    <div class="meta-pill"><b>Pris par</b> : ${i.handled_by ? escapeHtml(i.handled_by) : "‚Äî"}</div>

    <div class="meta-pill ${i.clients_present ? 'yes' : 'no'}">
      <b>Clients pr√©sents</b> : ${i.clients_present ? 'Oui' : 'Non'}
    </div>
    <div class="meta-pill ${i.entry_allowed ? 'yes' : 'no'}">
      <b>Autorisation d‚Äôentr√©e</b> : ${i.entry_allowed ? 'Oui' : 'Non'}
    </div>
  </div>`;

  const detail = `
    <div class="detail-box ${i.assigne==='M√©nage'?'menage':''}">
      <span class="label">D√©tail initial</span>
      <div class="txt">${escapeHtml(i.detail)}</div>
    </div>`;

  const actions=[];
  if(isReception) actions.push(btn("Re-assigner","assign",i.id));
  if(canWork && (i.status==="Assign√©e"||i.status==="Ouverte")) actions.push(btn("En cours","start",i.id));
  if(canWork && i.status==="En cours") actions.push(btn("Terminer","done",i.id));
  if(isReception) actions.push(btn("Supprimer","del",i.id,"danger"));

  const notesArr = Notes[i.id] || [];
  const notesList = notesArr.map(n=>`
    <div class="note">
      <div>${escapeHtml(n.body)}</div>
      <small>Ajout√©e par ${escapeHtml(n.by_user||'‚Äî')} ‚Äî ${new Date(n.created_at).toLocaleString()}</small>
    </div>
  `).join("");

  const noteForm = canAddNote ? `
    <div class="noteform">
      <label class="label" for="note-${i.id}">Ajouter un compl√©ment</label>
      <textarea id="note-${i.id}" data-note="${i.id}" placeholder="Pr√©cisions, r√©f√©rences, actions men√©es..."></textarea>
      <div class="actions">
        <button class="btn small" data-act="save-note" data-i="${i.id}">Enregistrer</button>
      </div>
    </div>` : "";

  const histArr = History[i.id] || [];
  const timeline = histArr.map(h=>`
    <div class="muted" style="font-size:.85rem">‚Ä¢ ${escapeHtml(h.action)} ‚Äî ${escapeHtml(h.by_user||'‚Äî')} ‚Äî ${new Date(h.at).toLocaleString()}</div>
  `).join("");

  wrap.innerHTML =
    hdr + meta + detail +
    `<div class="notes">${notesList || '<div class="muted" style="font-size:.9rem">Aucun compl√©ment.</div>'}</div>` +
    noteForm +
    `<div class="actions-row">${actions.join(" ")}</div>` +
    `<details style="margin-top:8px"><summary style="cursor:pointer">Historique</summary>${timeline||'<div class="muted" style="font-size:.85rem">Aucun √©v√©nement.</div>'}</details>`;

  // Events (actions boutons + note)
  wrap.addEventListener("click", async (e)=>{
    const b=e.target.closest("[data-act]"); if(!b) return;
    const act=b.dataset.act;
    if(act==="save-note"){
      const ta = wrap.querySelector(`textarea[data-note="${i.id}"]`);
      const txt = (ta?.value||"").trim(); if(!txt) return;
      await saveNote(i.id, txt);
      ta.value="";
      return;
    }
    await actionInterv(act, i);
  });

  return wrap;
}

function btn(txt,act,id,klass="secondary"){ return `<button class="btn ${klass} small" data-act="${act}" data-i="${id}">${txt}</button>`; }

/* ===== Chat Render ===== */
function renderChat(){
  if(!isLogged()) return;
  chatList.innerHTML = "";
  const me = current();
  Chat.slice(-300).forEach(m=>{
    const mine = me && (m.user_name === me.userId);
    const d = document.createElement("div");
    d.className = "msg" + (mine ? " me" : "");
    d.innerHTML =
      `<div class="muted" style="font-size:.8rem;margin-bottom:4px">
         ${m.role} ‚Äì ${m.user_name} ‚Ä¢ ${new Date(m.created_at).toLocaleString()}
       </div>${escapeHtml(m.text)}`;
    chatList.appendChild(d);
  });
  chatList.scrollTop = chatList.scrollHeight;
}

/* ===== Personnes ===== */
function renderPeople(){
  const c=People.clients||0, s=People.staff||0;
  document.getElementById("count-clients").textContent=c;
  document.getElementById("count-staff").textContent=s;
  document.getElementById("count-total").textContent=c+s;
}

/* ===== KPI ===== */
function refreshKPIs(){
  const openTech=Intervs.filter(i=>i.assigne==="Techniciens" && i.status!=="Termin√©e").length;
  const openMen =Intervs.filter(i=>i.assigne==="M√©nage"      && i.status!=="Termin√©e").length;
  document.getElementById("kpi-interv-tech").textContent=openTech;
  document.getElementById("kpi-interv-men").textContent=openMen;
  document.getElementById("kpi-people").textContent=(People.clients||0)+(People.staff||0);
  // ‚Äúnon lus‚Äù simplifi√© = derniers messages (pas de tracking par utilisateur ici)
  document.getElementById("kpi-chat").textContent=Math.max(0, Chat.length - 0);
}

/* ===== Export CSV ===== */
document.getElementById("exportCsv")?.addEventListener("click", ()=>{
  const rows = [
    ["ID","Type","Prio","Lieu","Detail","Assign√©","Statut","Cr√©√© le","Pris par","Clients pr√©sents","Entr√©e autoris√©e"]
  ].concat(Intervs.map(i=>[
    i.short_id || String(i.id).slice(-6), i.type, i.prio, i.lieu, i.detail, i.assigne, i.status,
    i.created_at, i.handled_by||"", i.clients_present?"Oui":"Non", i.entry_allowed?"Oui":"Non"
  ]));
  const csv = rows.map(r=>r.map(v=>`"${String(v??"").replace(/"/g,'""')}"`).join(",")).join("\n");
  const blob = new Blob([csv],{type:"text/csv;charset=utf-8;"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob); a.download = "interventions.csv"; a.click();
});

/* ===== Users (Admin) ‚Äî d√©mo locale ===== */
const userForm=document.getElementById("userForm"), userList=document.getElementById("userList");
userForm?.addEventListener("submit", e=>{ e.preventDefault(); const f=new FormData(userForm);
  const ok=addUser(f.get("u").trim(), f.get("p").trim(), f.get("r")); if(!ok) alert("Identifiant d√©j√† utilis√©.");
  userForm.reset(); renderUsers();
});
function renderUsers(){ const c=current(); if(!c || c.role!=="Admin") return; const list=getUsers(); userList.innerHTML="";
  list.forEach(u=>{ const div=document.createElement("div"); div.className="it";
    div.innerHTML=`<div class="ttl">${u.u} <span class="chip">${u.r}</span></div>`+(u.r!=="Admin"?`<div class="row"><button class="btn danger small" data-del="${u.u}">Supprimer</button></div>`:"");
    userList.appendChild(div);
  });
}
userList?.addEventListener("click", e=>{ const b=e.target.closest("[data-del]"); if(!b) return; delUser(b.dataset.del); renderUsers(); });

/* ===== Init ===== */
window.addEventListener("DOMContentLoaded", () => {
  setGreeting();
  enforceAuthUI();
});
</script>

</body>
</html>

